#!/usr/bin/make -f

# This file is auto generated by rsdk infra-package-update.
# DO NOT EDIT IT DIRECTLY!
# Custom rules should be placed in .github/local/rules.local

include /usr/share/dpkg/pkg-info.mk
include /usr/share/dpkg/architecture.mk
-include .github/local/rules.local

%:
	dh $@ $(EXTRA_DH_OPTIONS)

override_dh_auto_clean:
	dh_clean

override_dh_auto_configure:
	# Copy defconfig to .config and customize for cross-compilation
	cp wpa_supplicant/defconfig wpa_supplicant/.config
	echo "CC=aarch64-linux-gnu-gcc" >> wpa_supplicant/.config
	echo "STRIP=aarch64-linux-gnu-strip" >> wpa_supplicant/.config
	echo "CFLAGS += -Os" >> wpa_supplicant/.config
	echo "CFLAGS += -I/usr/include/libnl3/" >> wpa_supplicant/.config
	echo "CFLAGS += -I/usr/include/linux-private/" >> wpa_supplicant/.config
	echo "LIBS += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_c += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_p += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "CFLAGS += -I/usr/include/openssl/" >> wpa_supplicant/.config
	echo "LIBS += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_c += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_p += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LDFLAGS += -lpthread -lm" >> wpa_supplicant/.config
	echo "CONFIG_LIBNL32=y" >> wpa_supplicant/.config
	echo "CONFIG_EAP_FAST=y" >> wpa_supplicant/.config
	echo "CONFIG_DPP2=y" >> wpa_supplicant/.config
	echo "CONFIG_INTERWORKING=y" >> wpa_supplicant/.config

override_dh_auto_build:
	# Build wpa_supplicant
	$(MAKE) -C wpa_supplicant \
		CC=aarch64-linux-gnu-gcc \
		STRIP=aarch64-linux-gnu-strip \
		LIBDIR=/usr/lib/aarch64-linux-gnu

override_dh_auto_install:
	# Install binaries to debian/tmp
	install -d $(CURDIR)/debian/tmp/usr/bin
	install -d $(CURDIR)/debian/tmp/usr/share/man/man1
	install -d $(CURDIR)/debian/tmp/usr/share/man/man5
	install -d $(CURDIR)/debian/tmp/usr/share/man/man8
	install -d $(CURDIR)/debian/tmp/etc

	# Install binaries
	install -m 755 wpa_supplicant/wpa_supplicant \
		$(CURDIR)/debian/tmp/usr/bin/
	install -m 755 wpa_supplicant/wpa_cli \
		$(CURDIR)/debian/tmp/usr/bin/
	install -m 755 wpa_supplicant/wpa_passphrase \
		$(CURDIR)/debian/tmp/usr/bin/

	# Install man pages
	install -m 644 wpa_supplicant/doc/docbook/wpa_supplicant.8 \
		$(CURDIR)/debian/tmp/usr/share/man/man8/ 2>/dev/null || true
	install -m 644 wpa_supplicant/doc/docbook/wpa_cli.1 \
		$(CURDIR)/debian/tmp/usr/share/man/man1/ 2>/dev/null || true
	install -m 644 wpa_supplicant/doc/docbook/wpa_passphrase.1 \
		$(CURDIR)/debian/tmp/usr/share/man/man1/ 2>/dev/null || true
	install -m 644 wpa_supplicant/wpa_supplicant.conf \
		$(CURDIR)/debian/tmp/etc/wpa_supplicant.conf

override_dh_builddeb:
	mkdir -p $(CURDIR)/output
	dh_builddeb --destdir=$(CURDIR)/output -- -Zxz
