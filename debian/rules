#!/usr/bin/make -f

# This file is auto generated by rsdk infra-package-update.
# DO NOT EDIT IT DIRECTLY!
# Custom rules should be placed in .github/local/rules.local

include /usr/share/dpkg/pkg-info.mk
include /usr/share/dpkg/architecture.mk
-include .github/local/rules.local

%:
	dh $@ $(EXTRA_DH_OPTIONS)

override_dh_auto_clean:
	dh_clean
	$(MAKE) -C wpa_supplicant clean

override_dh_auto_configure:
	# Copy defconfig to .config and customize for cross-compilation
	cp wpa_supplicant/defconfig wpa_supplicant/.config
	echo "CC=aarch64-linux-gnu-gcc" >> wpa_supplicant/.config
	echo "STRIP=aarch64-linux-gnu-strip" >> wpa_supplicant/.config
	echo "CFLAGS += -Os" >> wpa_supplicant/.config
	echo "CFLAGS += -I/usr/include/libnl3/" >> wpa_supplicant/.config
	echo "CFLAGS += -I/usr/include/linux-private/" >> wpa_supplicant/.config
	echo "LIBS += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_c += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_p += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "CFLAGS += -I/usr/include/openssl/" >> wpa_supplicant/.config
	echo "LIBS += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_c += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LIBS_p += -L/usr/lib/aarch64-linux-gnu/" >> wpa_supplicant/.config
	echo "LDFLAGS += -lpthread -lm" >> wpa_supplicant/.config
	echo "CONFIG_LIBNL32=y" >> wpa_supplicant/.config
	echo "CONFIG_EAP_FAST=y" >> wpa_supplicant/.config
	echo "CONFIG_DPP2=y" >> wpa_supplicant/.config
	echo "CONFIG_INTERWORKING=y" >> wpa_supplicant/.config

override_dh_auto_build:
	# Build wpa_supplicant_s1g (the default target in this modified source)
	$(MAKE) -C wpa_supplicant \
		CC=aarch64-linux-gnu-gcc \
		STRIP=aarch64-linux-gnu-strip \
		LIBDIR=/usr/lib/aarch64-linux-gnu

override_dh_auto_install:
	# Install binaries to debian/tmp
	install -d $(CURDIR)/debian/tmp/usr/bin
	install -d $(CURDIR)/debian/tmp/etc

	# Install binaries (s1g versions for this modified source)
	install -m 755 wpa_supplicant/wpa_supplicant_s1g \
		$(CURDIR)/debian/tmp/usr/bin/wpa_supplicant
	install -m 755 wpa_supplicant/wpa_cli_s1g \
		$(CURDIR)/debian/tmp/usr/bin/wpa_cli
	install -m 755 wpa_supplicant/wpa_passphrase_s1g \
		$(CURDIR)/debian/tmp/usr/bin/wpa_passphrase
	install -m 644 wpa_supplicant/wpa_supplicant.conf \
		$(CURDIR)/debian/tmp/etc/wpa_supplicant.conf

override_dh_builddeb:
	mkdir -p $(CURDIR)/output
	dh_builddeb --destdir=$(CURDIR)/output -- -Zxz
